<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat ‚Äî Optimizado</title>

    <!-- Firebase SDK (modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Pega tu config aqu√≠ si quieres cambiar ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB8Ffk2v4SzHpuSdAtwBo9mMk7d-FVoEk",
            authDomain: "again-39689.firebaseapp.com",
            projectId: "again-39689",
            storageBucket: "again-39689.firebasestorage.app",
            messagingSenderId: "777451941392",
            appId: "1:777451941392:web:1e2ffbb0817a0c5019a495",
            measurementId: "G-6P2YR4RLFJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.__FIRE = { db };
    </script>

    <style>
        :root {
            --side-width: 320px;
            --muted: #94a3b8;
            --accent: #7dd3fc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Arial;
            background: #04060a;
            color: #e6eef8;
            display: flex;
            justify-content: center;
            padding: 16px;
            min-height: 100vh;
        }

        .card {
            width: 100%;
            max-width: 1100px;
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            gap: 1px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            min-height: 560px;
            max-height: 90vh;
        }

        /* Panel izquierdo */
        .panel-left {
            width: var(--side-width);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 40vh;
            overflow: auto;
            padding-right: 6px;
        }

        .room-item {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
        }

        .room-item.active {
            background: linear-gradient(90deg, rgba(125, 211, 252, 0.06), rgba(125, 211, 252, 0.02));
            color: var(--accent);
            font-weight: 700;
            border-color: rgba(125, 211, 252, 0.12);
        }

        /* Panel derecho */
        .panel-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #001 0%, #032 100%);
            position: relative;
        }

        .header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Mensajes */
        .messages {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            min-height: 220px;
            max-height: calc(90vh - 240px);
            scroll-behavior: smooth;
        }

        /* Burbujas */
        .msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            gap: 8px;
            align-items: flex-start;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s ease-in-out;
            position: relative;
        }

        .msg.daniel {
            align-self: flex-end;
            background: rgba(189, 61, 78, 0.41);
            flex-direction: row-reverse;
            color: #fff;
        }

        .msg.leidy {
            align-self: flex-start;
            background: #252a36;
            color: #e6eef8;
        }

        /* Avatar */
        .bubble-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.06);
        }

        .bubble-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Contenido burbuja */
        .bubble-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 100%;
        }

        .bubble-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .bubble-image {
            width: 220px;
            max-width: 100%;
            border-radius: 12px;
            margin-top: 6px;
        }

        /* Composer */
        .composer {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.02);
            align-items: center;
        }

        .composer input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            background: rgba(255, 255, 255, 0.02);
            color: inherit;
        }

        .btn-send {
            padding: 10px 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, #06b6d4, #38bdf8);
            color: #042431;
            font-weight: 700;
            cursor: pointer;
        }

        /* Indicador escribiendo */
        .typing-indicator {
            font-size: 13px;
            color: #7dd3fc;
            padding-left: 12px;
            font-style: italic;
            height: 20px;
            display: flex;
            align-items: center;
        }

        .typing-indicator span::after {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-left: 3px;
            margin-right: 1px;
            background: #7dd3fc;
            border-radius: 50%;
            animation: blink 1s infinite alternate;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
                transform: scale(0.6);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0.2;
                transform: scale(0.6);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stickers panel */
        .sticker-panel {
            position: absolute;
            left: calc(var(--side-width)+12px);
            bottom: 72px;
            right: 20px;
            max-height: 220px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 10px;
            display: none;
            overflow: auto;
            z-index: 50;
        }

        .sticker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sticker-item {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 720px) {
            .panel-left {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .msg {
                max-width: 90%;
                font-size: 14px;
                margin-right: 12px;
            }

            .composer {
                flex-direction: column;
            }

            .btn-send,
            .btn-ico {
                width: 100%;
                margin-top: 4px;
            }

            .bubble-avatar {
                width: 28px;
                height: 28px;
            }
        }

        .msg-menu {
    position: absolute;
    background: rgba(20,20,30,0.95);
    color: #fff;
    padding: 6px;
    border-radius: 8px;
    display: none;
    flex-direction: column;
    z-index: 100;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.msg-menu .menu-item {
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s;
}

.msg-menu .menu-item:hover {
    background: rgba(125,211,252,0.1);
}
/* Fotos de perfil m√°s peque√±as en m√≥vil */
@media (max-width: 480px) {
    .avatar img,
    .bubble-avatar img {
        width: 28px !important;
        height: 28px !important;
    }
}

/* Botones de audio, stickers e imagen m√°s compactos */
.btn-ico {
    padding: 6px 8px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: rgba(125, 211, 252, 0.1);
    color: #7dd3fc;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-ico:hover {
    background: rgba(125, 211, 252, 0.2);
}

/* Composer en m√≥vil m√°s compacto */
@media (max-width: 480px) {
    .composer {
        gap: 2px;
        padding: 2px;
    }

    .btn-send {
        padding: 8px 12px;
        font-size: 14px;
    }

    #msgInput {
        padding: 8px 4px;
        font-size: 11px;
    }
}

/* Reducir tama√±o de stickers dentro de panel en m√≥vil */
@media (max-width: 480px) {
    .sticker-item img {
        width: 48px;
        height: 48px;
    }
}
/* ==== ESTILOS TIPO WHATSAPP PARA M√ìVIL ==== */
@media (max-width: 480px) {
    /* Panel derecho ocupa toda la pantalla */
    .panel-right {
        padding: 8px;
    }
    .messages{
        padding: 2px;
    }
    /* Avatar m√°s peque√±o */
    .avatar img,
    .bubble-avatar img {
        width: 28px !important;
        height: 28px !important;
    }

    /* Burbuja de mensaje m√°s compacta */
    .msg {
        max-width: 85%;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 12px;
    }

    .bubble-image {
        width: 160px;
        max-width: 70%;
        border-radius: 10px;
    }

    audio {
        width: 160px;
    }



    #msgInput {
        flex: 1;
        padding: 8px 10px;
        font-size: 14px;
        width: 100%;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.03);
        background: rgba(255,255,255,0.02);
    }

    /* Botones circulares peque√±os */
    .btn-ico {
        width: 36px;
        height: 36px;
        padding: 0;
        font-size: 18px;
        border-radius: 50%;
        background: rgba(125,211,252,0.1);
        color: #7dd3fc;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-ico:hover {
        background: rgba(125,211,252,0.2);
    }

    .btn-send {
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 20px;
        background: linear-gradient(90deg, #06b6d4, #38bdf8);
        color: #042431;
    }
    .card{
        max-height: 94vh;
    }
    /* Panel de stickers compacto */
    .sticker-panel {
        bottom: 64px;
        padding: 6px;
        max-height: 180px;
        scrollbar-width: auto;
    }

    .sticker-item {
        width: 48px;
        height: 48px;
        border-radius: 8px;
    }

    .sticker-item img {
        width: 100%;
        height: 100%;
        object-fit: fill;
    }
    .botonesxd{
        display: flex;
        gap: 6px;
    }
}
/* Mantener avatar visible al lado del mensaje */
@media (max-width: 480px) {
    .msg {
        display: flex !important;
        flex-direction: row !important; /* evita que se invierta */
        align-items: flex-start;
        gap: 6px;
    }

    .bubble-avatar {
        display: block !important; /* aseg√∫rate que siempre se vea */
    }

    .bubble-content {
        max-width: calc(100% - 36px); /* deja espacio para el avatar */
    }
}
@media (max-width: 480px) {
    .bubble-image {
        width: 120px;
        max-width: 70%;
        border-radius: 10px;
    }
}

    </style>

</head>

<body>
    <div id="msgMenu" class="msg-menu" aria-hidden="true">
        <div class="menu-item" data-react="‚ù§Ô∏è">‚ù§Ô∏è</div>
        <div class="menu-item" data-react="üëç">üëç</div>
        <div class="menu-item" data-react="üòÇ">üòÇ</div>
        <div class="menu-item" data-react="üî•">üî•</div>
        <div class="menu-item" data-action="reply">üí¨ Responder</div>
    </div>

    <div class="card" id="appCard">
       <div class="panel-left">
    <div class="rooms-header" style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Salas</div>
    </div>
    <div class="rooms-list" id="roomList"></div>
    <div style="margin-top:auto" class="meta">Perfil activo: <span id="activeName" class="small">‚Äî</span></div>
</div>


        <div class="panel-right">
            <div class="header">
                <div style="display:flex;gap:12px;align-items:center">
                    <!-- header avatar ahora con lazy + decoding -->
                    <div class="avatar"><img src="daniel.jpg" id="headerAvatarImg" loading="lazy" decoding="async"
                            style="width:52px;height:52px;object-fit:cover" onerror="this.style.display='none'"></div>
                    <div>
                        <div id="chatTitle" class="chat-title">Selecciona una sala</div>
                        <div id="chatSub" class="chat-sub">Inicia sesi√≥n</div>
                    </div>
                </div>
                <div><small class="small">Chat </small></div>
            </div>

            <div id="messages" class="messages" aria-live="polite"></div>
            <div id="typingIndicator" class="typing-indicator"></div>

            <div id="loadMore" class="load-more" style="display:none">‚¨Ü Cargar m√°s historial</div>

            <div class="sticker-panel" id="stickerPanel" aria-hidden="true">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
                    <div style="font-weight:700">Stickers</div><button id="closeStickers"
                        style="background:transparent;border:none;color:var(--muted);cursor:pointer">Cerrar</button>
                </div>
                <div class="sticker-grid" id="stickerGrid"></div>
            </div>

            <form id="composer" class="composer" onsubmit="return false;" style="display:none">
                <input id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off" />
                <div class="botonesxd">
                <button id="btnRecord" class="btn-ico" type="button" title="Grabar audio">üé§</button>
                <button id="btnSticker" class="btn-ico" type="button" title="Stickers">üü°</button>
                <button id="btnImage" class="btn-ico" type="button" title="Enviar imagen">üñºÔ∏è</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display:none">
                <button id="sendBtn" class="btn-send">Enviar</button>
            </form>
        </div>
    </div>

    <div class="overlay" id="loginOverlay"
        style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60">
        <div
            style="background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;width:100%;max-width:420px;">
            <h2>Acceso al chat</h2>
            <div style="display:flex;gap:8px">
                <input id="passwordInput" placeholder="Contrase√±a secreta"
                    style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:inherit" />
                <button id="loginBtn" class="btn-send">Entrar</button>
            </div>
        </div>
    </div>

    <script>
        (async function () {
            // ---------------- CONFIG ----------------
            const ROOM_ID = "general";
            const ROOM_NAME = "General";
            const CACHE_LIMIT = 5000;
            const PAGE_SIZE = 40;
            const DEBOUNCE_MS = 400;
            const STICKERS = ["pollo.png", "sticker1.png", "sticker2.webp", "sticker3.webp", "sticker4.webp", "sticker5.webp", "sticker6.webp", "sticker7.webp", "sticker9.webp", "hey-floppa.webp", "no-no-cat.webp", "no-no-cat.webp"];

            // DOM
            const loginOverlay = document.getElementById('loginOverlay');
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');
            const activeNameEl = document.getElementById('activeName');
            const messagesEl = document.getElementById('messages');
            const composer = document.getElementById('composer');
            const msgInput = document.getElementById('msgInput');
            const sendBtn = document.getElementById('sendBtn');
            const roomListEl = document.getElementById('roomList'); // panel izquierdo
            const btnRecord = document.getElementById('btnRecord');
            const btnSticker = document.getElementById('btnSticker');
            const stickerPanel = document.getElementById('stickerPanel');
            const stickerGrid = document.getElementById('stickerGrid');
            const closeStickers = document.getElementById('closeStickers');
            const btnImage = document.getElementById('btnImage');
            const imageInput = document.getElementById('imageInput');

            // STATE
            const accessKeys = { "marzo10": "leidy", "enero10": "daniel" };
            let currentUser = null;
            let newestTimestamp = 0;
            let replyTo = null;
            let recorder = null, audioChunks = [];
            let sendTimer = null;
            let typingTimer = null;
            const TYPING_TIMEOUT = 1500;

            // --------------- FIREBASE HELPERS -----------------
            function fire() { return window.__FIRE && window.__FIRE.db ? window.__FIRE : null; }
            async function ensureFireReady() { const start = Date.now(); while (!fire() || !fire().db) { if (Date.now() - start > 3000) break; await new Promise(r => setTimeout(r, 50)); } }

            // --------------- CACHE -----------------
            function loadCache() { try { const raw = localStorage.getItem('chat_cache'); return raw ? JSON.parse(raw) : { msgs: [], newest: 0 }; } catch (e) { return { msgs: [], newest: 0 }; } }
            function saveCache(cache) { try { if (cache.msgs.length > CACHE_LIMIT) cache.msgs = cache.msgs.slice(-CACHE_LIMIT); localStorage.setItem('chat_cache', JSON.stringify(cache)); } catch (e) { } }

            // --------------- LOGIN -----------------
            loginBtn.addEventListener('click', tryLogin);
            passwordInput.addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

            function tryLogin() {
                const pass = passwordInput.value.trim();
                const name = accessKeys[pass];
                if (!name) return alert('Contrase√±a incorrecta');
                currentUser = name;
                activeNameEl.textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
                loginOverlay.style.display = 'none';
                composer.style.display = 'flex';
                initRoomList();
                loadStickers();
                initChat();
            }

            // ----------------- ROOM LIST -----------------
            async function initRoomList() {
                await ensureFireReady();
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, doc, getDoc, setDoc } = fs;
                roomListEl.innerHTML = `<div class="room-item active" id="room-${ROOM_ID}">${ROOM_NAME}</div>`;
                // Crear sala si no existe
                const roomRef = doc(fire().db, 'chat_rooms', ROOM_ID);
                const snap = await getDoc(roomRef);
                if (!snap.exists()) { await setDoc(roomRef, { name: ROOM_NAME, createdAt: Date.now() }); }
            }

            // --------------- STICKERS -----------------
            function loadStickers() {
                stickerGrid.innerHTML = '';
                STICKERS.forEach(s => {
                    const item = document.createElement('div'); item.className = 'sticker-item';
                    const img = document.createElement('img'); img.src = 'stickers/' + s;
                    item.appendChild(img);
                    item.addEventListener('click', async () => { await sendMessage({ sticker: img.src }); hideStickers(); });
                    stickerGrid.appendChild(item);
                });
            }
            btnSticker.addEventListener('click', e => { e.preventDefault(); toggleStickers(); });
            closeStickers.addEventListener('click', hideStickers);
            function toggleStickers() { stickerPanel.style.display = (stickerPanel.style.display === 'block') ? 'none' : 'block'; }
            function hideStickers() { stickerPanel.style.display = 'none'; }

            // ----------------- IMAGE UPLOAD -----------------
            btnImage.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', () => {
                const file = imageInput.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onloadend = async () => { await sendMessage({ image: reader.result }); imageInput.value = ''; };
                reader.readAsDataURL(file);
            });

            // ----------------- AUDIO -----------------
            btnRecord.addEventListener('click', async e => { e.preventDefault(); if (recorder && recorder.state === 'recording') stopRecording(); else await startRecording(); });
            async function startRecording() {
                if (!currentUser) return alert('Entra al chat antes de grabar');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    recorder = new MediaRecorder(stream); audioChunks = [];
                    recorder.ondataavailable = e => { if (e.data && e.data.size) audioChunks.push(e.data); };
                    recorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
                        if (blob.size > 1024 * 1024 * 0.9) { alert('Audio muy grande'); return; }
                        const reader = new FileReader();
                        reader.onloadend = async () => { await sendMessage({ audio: reader.result, mime: blob.type }); };
                        reader.readAsDataURL(blob);
                        try { stream.getTracks().forEach(t => t.stop()); } catch (e) { }
                    };
                    recorder.start(); btnRecord.textContent = '‚èπÔ∏è Grabando...';
                    setTimeout(() => { if (recorder && recorder.state === 'recording') stopRecording(); }, 20000);
                } catch (e) { alert('No se pudo acceder al micr√≥fono'); console.error(e); }
            }
            function stopRecording() { if (recorder && recorder.state === 'recording') recorder.stop(); recorder = null; btnRecord.textContent = 'üé§'; }

            // ----------------- CHAT INIT -----------------
            async function initChat() {
                await ensureFireReady();
                await loadLatestMessages();
                listenNewMessages();
                listenTypingStatus();
            }

            async function loadLatestMessages() {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, query, orderBy, limit, getDocs } = fs;
                const msgsRef = collection(fire().db, `chat_rooms/${ROOM_ID}/messages`);
                try {
                    const q = query(msgsRef, orderBy('time', 'desc'), limit(PAGE_SIZE));
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        const docs = snap.docs.reverse();
                        const msgs = docs.map(d => ({ id: d.id, ...d.data() }));
                        newestTimestamp = msgs[msgs.length - 1].time || Date.now();
                        saveCache({ msgs, newest: newestTimestamp });
                        renderMessages(msgs);
                    }
                } catch (e) { console.error('loadLatestMessages', e); }
            }

            async function listenNewMessages() {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, query, where, orderBy, onSnapshot } = fs;
                const msgsRef = collection(fire().db, `chat_rooms/${ROOM_ID}/messages`);
                const qNew = query(msgsRef, where('time', '>', newestTimestamp), orderBy('time'));
                onSnapshot(qNew, snap => {
                    if (!snap.empty) { appendNewMessages(snap.docs.map(d => ({ id: d.id, ...d.data() }))); }
                });
            }

            function appendNewMessages(newMsgs) {
                if (!newMsgs || !newMsgs.length) return;
                const cache = loadCache();
                const existingIds = new Set(cache.msgs.map(m => m.id));
                const filtered = newMsgs.filter(m => !existingIds.has(m.id));
                if (!filtered.length) return;
                cache.msgs = cache.msgs.concat(filtered);
                cache.newest = Math.max(cache.newest || 0, ...filtered.map(m => m.time || 0));
                saveCache(cache);
                filtered.forEach(m => appendMessageToDOM(m));
                newestTimestamp = cache.newest;
            }

            // ----------------- SEND MESSAGE -----------------
            async function sendMessage(extra = {}) {
                if (!currentUser) return;
                const text = msgInput?.value?.trim() || '';
                if (!text && !extra.audio && !extra.sticker && !extra.image) return;
                if (sendTimer) clearTimeout(sendTimer);
                sendTimer = setTimeout(async () => {
                    const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                    const { collection, addDoc } = fs;
                    const data = { from: currentUser, time: Date.now(), text: text || '', ...extra };
                    if (replyTo) { data.replyTo = { id: replyTo.id, from: replyTo.from, text: replyTo.text || null }; replyTo = null; msgInput.placeholder = 'Escribe un mensaje...'; }
                    try { await addDoc(collection(fire().db, `chat_rooms/${ROOM_ID}/messages`), data); if (msgInput) msgInput.value = ''; }
                    catch (e) { console.error('sendMessage', e); alert('No se pudo enviar'); }
                }, DEBOUNCE_MS);
            }
            sendBtn.addEventListener('click', e => { e.preventDefault(); sendMessage(); });
            msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

            // ----------------- TYPING -----------------
            msgInput.addEventListener('input', () => {
                setTypingStatus(true);
                if (typingTimer) clearTimeout(typingTimer);
                typingTimer = setTimeout(() => setTypingStatus(false), TYPING_TIMEOUT);
            });

            async function setTypingStatus(isTyping) {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { doc, setDoc } = fs;
                try {
                    await setDoc(doc(fire().db, `chat_rooms/${ROOM_ID}/typing_status`, currentUser), { typing: isTyping, time: Date.now() }, { merge: true });
                } catch (e) { console.error(e); }
            }

            async function listenTypingStatus() {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, onSnapshot } = fs;
                onSnapshot(collection(fire().db, `chat_rooms/${ROOM_ID}/typing_status`), snap => {
                    const typingUsers = [];
                    snap.docs.forEach(d => { const data = d.data(); if (data.typing && d.id !== currentUser) typingUsers.push(d.id); });
                    document.getElementById('typingIndicator').textContent = typingUsers.length ? `${typingUsers.join(', ')} escribiendo...` : '';
                });
            }

            // ----------------- RENDER -----------------
            function renderMessages(list) { messagesEl.innerHTML = ''; list.forEach(m => appendMessageToDOM(m)); }
            function appendMessageToDOM(m) {
    const cache = loadCache();
    cache.msgs.push(m);
    if (cache.msgs.length > CACHE_LIMIT) cache.msgs = cache.msgs.slice(-CACHE_LIMIT);
    cache.newest = Math.max(cache.newest || 0, m.time || 0);
    saveCache(cache);

    const div = document.createElement('div');
    div.className = 'msg ' + ((m.from === currentUser) ? 'daniel' : 'leidy');

    // Determinar avatar
    const avatarUrl = m.from === 'daniel' ? 'daniel.jpg' : 'leidy.jpg';

    // HTML del mensaje
    let inner = `
      <div class="bubble-avatar"><img src="${avatarUrl}" loading="lazy" decoding="async" onerror="this.style.display='none'"></div>
      <div class="bubble-content">
        <div class="bubble-name">${m.from || ''}</div>
    `;

    if (m.replyTo) inner += `<div class="reply-box">${m.replyTo.from}: ${m.replyTo.text || 'Imagen'}</div>`;
    if (m.text) inner += `<div class="bubble-text">${m.text}</div>`;
    if (m.image) inner += `<img src="${m.image}" class="bubble-image" loading="lazy" decoding="async">`;
    if (m.sticker) inner += `<img src="${m.sticker}" class="bubble-image" style="width:140px;border-radius:12px">`;
    if (m.audio) inner += `<audio controls preload="none" src="${m.audio}"></audio>`;
    if (m.reaction) inner += `<div class="reaction">${m.reaction}</div>`;

    inner += `<div class="bubble-meta">${new Date(m.time || Date.now()).toLocaleTimeString()}</div></div>`;

    div.innerHTML = inner;

    // Permitir responder al mensaje
    div.addEventListener('click', () => { replyTo = m; });

    messagesEl.appendChild(div);

    // Scroll autom√°tico
    messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
}


            // click fuera oculta stickers
            document.addEventListener('click', e => { if (stickerPanel.style.display === 'block' && !stickerPanel.contains(e.target) && !btnSticker.contains(e.target)) hideStickers(); });

        })();
    </script>


</body>

</html>