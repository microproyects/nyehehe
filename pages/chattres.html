<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat ‚Äî Optimizado</title>

    <!-- Firebase SDK (modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Pega tu config aqu√≠ si quieres cambiar ---
        const firebaseConfig = {
apiKey: "AIzaSyBkr6A5kTm4HBoCJeGGi-hPAQjTTKhfqg0",
  authDomain: "fitness2-542b2.firebaseapp.com",
  projectId: "fitness2-542b2",
  storageBucket: "fitness2-542b2.firebasestorage.app",
  messagingSenderId: "464358271227",
  appId: "1:464358271227:web:6b21ef82e218f9b4e3a85e",
  measurementId: "G-MYJ5KZB8MV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.__FIRE = { db };
    </script>

    <style>
        :root {
            --side-width: 320px;
            --muted: #94a3b8;
            --accent: #7dd3fc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Arial;
            background: #04060a;
            color: #e6eef8;
            display: flex;
            justify-content: center;
            padding: 16px;
            min-height: 100vh;
        }

        .card {
            width: 100%;
            max-width: 1100px;
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            gap: 1px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            min-height: 560px;
            max-height: 90vh;
        }

        /* Panel izquierdo */
        .panel-left {
            width: var(--side-width);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 40vh;
            overflow: auto;
            padding-right: 6px;
        }

        .room-item {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
        }

        .room-item.active {
            background: linear-gradient(90deg, rgba(125, 211, 252, 0.06), rgba(125, 211, 252, 0.02));
            color: var(--accent);
            font-weight: 700;
            border-color: rgba(125, 211, 252, 0.12);
        }

        /* Panel derecho */
        .panel-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #001 0%, #032 100%);
            position: relative;
        }

        .header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Mensajes */
        .messages {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            min-height: 220px;
            max-height: calc(90vh - 240px);
            scroll-behavior: smooth;
        }

        /* Burbujas */
        .msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            gap: 8px;
            align-items: flex-start;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s ease-in-out;
            position: relative;
        }

        .msg.daniel {
            align-self: flex-end;
            background: rgba(189, 61, 78, 0.41);
            flex-direction: row-reverse;
            color: #fff;
        }

        .msg.leidy {
            align-self: flex-start;
            background: #252a36;
            color: #e6eef8;
        }

        /* Avatar */
        .bubble-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;

            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.06);
        }

        .bubble-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Contenido burbuja */
        .bubble-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 100%;
        }

        .bubble-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .bubble-image {
            width: 220px;
            max-width: 100%;
            border-radius: 12px;
            margin-top: 6px;
        }

        /* Composer */
        .composer {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.02);
            align-items: center;
        }

        .composer input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            background: rgba(255, 255, 255, 0.02);
            color: inherit;
        }

        .btn-send {
            padding: 10px 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, #06b6d4, #38bdf8);
            color: #042431;
            font-weight: 700;
            cursor: pointer;
        }

        /* Indicador escribiendo */
        .typing-indicator {
            font-size: 13px;
            color: #7dd3fc;
            padding-left: 12px;
            font-style: italic;
            height: 20px;
            display: flex;
            align-items: center;
        }

        .typing-indicator span::after {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-left: 3px;
            margin-right: 1px;
            background: #7dd3fc;
            border-radius: 50%;
            animation: blink 1s infinite alternate;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
                transform: scale(0.6);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0.2;
                transform: scale(0.6);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stickers panel */
        .sticker-panel {
            position: absolute;
            left: calc(var(--side-width)+12px);
            bottom: 72px;
            right: 20px;
            max-height: 220px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 10px;
            display: none;
            overflow: auto;
            z-index: 50;
        }

        .sticker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sticker-item {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 720px) {
            .panel-left {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .msg {
                max-width: 90%;
                font-size: 14px;
                margin-right: 12px;
            }

            .composer {
                flex-direction: column;
            }

            .btn-send,
            .btn-ico {
                width: 100%;
                margin-top: 4px;
            }

            .bubble-avatar {
                width: 28px;
                height: 28px;
            }
        }

        .msg-menu {
            position: absolute;
            background: rgba(20, 20, 30, 0.95);
            color: #fff;
            padding: 6px;
            border-radius: 8px;
            display: none;
            flex-direction: column;
            z-index: 100;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .msg-menu .menu-item {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .msg-menu .menu-item:hover {
            background: rgba(125, 211, 252, 0.1);
        }

        /* Fotos de perfil m√°s peque√±as en m√≥vil */
        @media (max-width: 480px) {

            .avatar img,
            .bubble-avatar img {
                width: 28px !important;
                height: 28px !important;
            }
        }

        /* Botones de audio, stickers e imagen m√°s compactos */
        .btn-ico {
            padding: 6px 8px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: rgba(125, 211, 252, 0.1);
            color: #7dd3fc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-ico:hover {
            background: rgba(125, 211, 252, 0.2);
        }

        /* Composer en m√≥vil m√°s compacto */
        @media (max-width: 480px) {
            .composer {
                gap: 2px;
                padding: 2px;
            }

            .btn-send {
                padding: 8px 12px;
                font-size: 14px;
            }

            #msgInput {
                padding: 8px 4px;
                font-size: 11px;
            }
        }

        /* Reducir tama√±o de stickers dentro de panel en m√≥vil */
        @media (max-width: 480px) {
            .sticker-item img {
                width: 48px;
                height: 48px;
            }
        }

        /* ==== ESTILOS TIPO WHATSAPP PARA M√ìVIL ==== */
        @media (max-width: 480px) {

            /* Panel derecho ocupa toda la pantalla */
            .panel-right {
                padding: 8px;
            }

            .messages {
                padding: 2px;
            }

            /* Avatar m√°s peque√±o */
            .avatar img,
            .bubble-avatar img {
                width: 28px !important;
                height: 28px !important;
            }

            /* Burbuja de mensaje m√°s compacta */
            .msg {
                max-width: 85%;
                font-size: 13px;
                padding: 8px 10px;
                border-radius: 12px;
            }

            .bubble-image {
                width: 160px;
                max-width: 70%;
                border-radius: 10px;
            }

            audio {
                width: 160px;
            }



            #msgInput {
                flex: 1;
                padding: 8px 10px;
                font-size: 14px;
                width: 100%;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.03);
                background: rgba(255, 255, 255, 0.02);
            }

            /* Botones circulares peque√±os */
            .btn-ico {
                width: 36px;
                height: 36px;
                padding: 0;
                font-size: 18px;
                border-radius: 50%;
                background: rgba(125, 211, 252, 0.1);
                color: #7dd3fc;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-ico:hover {
                background: rgba(125, 211, 252, 0.2);
            }

            .btn-send {
                padding: 6px 12px;
                font-size: 14px;
                border-radius: 20px;
                background: linear-gradient(90deg, #06b6d4, #38bdf8);
                color: #042431;
            }

            .card {
                max-height: 94vh;
            }

            /* Panel de stickers compacto */
            .sticker-panel {
                bottom: 64px;
                padding: 6px;
                max-height: 180px;
                scrollbar-width: auto;
            }

            .sticker-item {
                width: 48px;
                height: 48px;
                border-radius: 8px;
            }

            .sticker-item img {
                width: 100%;
                height: 100%;
                object-fit: fill;
            }

            .botonesxd {
                display: flex;
                gap: 6px;
            }
        }

        /* Mantener avatar visible al lado del mensaje */
        @media (max-width: 480px) {
            .msg {
                display: flex !important;
                flex-direction: row !important;
                /* evita que se invierta */
                align-items: flex-start;
                gap: 6px;
            }

            .bubble-avatar {
                display: block !important;
                /* aseg√∫rate que siempre se vea */
            }

            .bubble-content {
                max-width: calc(100% - 36px);
                /* deja espacio para el avatar */
            }
        }

        @media (max-width: 480px) {
            .bubble-image {
                width: 120px;
                max-width: 70%;
                border-radius: 10px;
            }
        }

        #recordUI {
            position: fixed;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 14px;
            border-radius: 14px;
            display: none;
            flex-direction: column;
            gap: 6px;
            width: 260px;
            z-index: 9999;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
            animation: slideUp .25s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .record-box {
            text-align: center;
            color: white;
        }

        .record-title {
            font-size: 16px;
            font-weight: 600;
            color: #ff5656;
        }

        .record-timer {
            font-size: 22px;
            margin-top: 4px;
        }

        .record-size {
            font-size: 12px;
            opacity: .7;
            margin-bottom: 6px;
        }

        #recCancel,
        #recSend {
            width: 100%;
            border: none;
            padding: 8px;
            margin-top: 4px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        #recCancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        #recSend {
            background: #06b6d4;
            color: #042431;
        }

        .msg-menu {
            position: absolute;
            background: #222;
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 99999;
            animation: fadeIn .15s ease;
        }

        .msg-menu div {
            padding: 6px 10px;
            background: #333;
            border-radius: 6px;
        }

        .msg-menu div:active {
            background: #444;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .msg-menu {
            position: absolute;
            background: linear-gradient(180deg, #1b1b25, #121219);
            color: #eaf6ff;
            padding: 8px;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            gap: 6px;
            z-index: 99999;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);
            min-width: 120px;
            transform-origin: top left;
        }

        .msg-menu .menu-item {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background .12s;
        }

        .msg-menu .menu-item:hover {
            background: rgba(125, 211, 252, 0.08);
        }

        @keyframes menuPop {
            from {
                opacity: 0;
                transform: scale(.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

</head>

<body>



    <div class="card" id="appCard">
        <div class="panel-left">
            <div class="rooms-header" style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">Chat DOSSS</div>
            </div>
            <div class="rooms-list" id="roomList"></div>
            <div style="margin-top:auto" class="meta">Perfil activo: <span id="activeName" class="small">‚Äî</span></div>
        </div>


        <div class="panel-right">
            <div class="header">
                <div style="display:flex;gap:12px;align-items:center">
                    <!-- header avatar ahora con lazy + decoding -->
                    <div class="avatar"><img src="daniel.jpg" id="headerAvatarImg" loading="lazy" decoding="async"
                            style="width:52px;height:52px;object-fit:cover" onerror="this.style.display='none'"></div>
                    <div>
                        <div id="chatTitle" class="chat-title">Selecciona una sala</div>
                        <div id="chatSub" class="chat-sub">Inicia sesi√≥n</div>
                    </div>
                </div>
                <div><small class="small">Chat </small></div>
            </div>

            <div id="messages" class="messages" aria-live="polite"></div>
            <div id="typingIndicator" class="typing-indicator"></div>

            <div id="loadMore" class="load-more" style="display:none">‚¨Ü Cargar m√°s historial</div>

            <div class="sticker-panel" id="stickerPanel" aria-hidden="true">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
                    <div style="font-weight:700">Stickers</div><button id="closeStickers"
                        style="background:transparent;border:none;color:var(--muted);cursor:pointer">Cerrar</button>
                </div>
                <div class="sticker-grid" id="stickerGrid"></div>
            </div>

            <form id="composer" class="composer" onsubmit="return false;" style="display:none">
                <input id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off" />
                <div class="botonesxd">
                    <button id="btnRecord" class="btn-ico" type="button" title="Grabar audio">üé§</button>
                    <button id="btnSticker" class="btn-ico" type="button" title="Stickers">üü°</button>
                    <button id="btnImage" class="btn-ico" type="button" title="Enviar imagen">üñºÔ∏è</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display:none">
                <button id="sendBtn" class="btn-send">Enviar</button>
            </form>
        </div>
    </div>

    <div class="overlay" id="loginOverlay"
        style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60">
        <div
            style="background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;width:100%;max-width:420px;">
            <h2>Acceso al chat</h2>
            <div style="display:flex;gap:8px">
                <input id="passwordInput" placeholder="Contrase√±a secreta"
                    style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:inherit" />
                <button id="loginBtn" class="btn-send">Entrar</button>
            </div>
        </div>
    </div>
    <div id="msgMenu" class="msg-menu" aria-hidden="true" style="display:none">
        <div id="menuReply" class="menu-item">üí¨ Responder</div>
        <div id="menuReact" class="menu-item">‚ù§Ô∏è Reaccionar</div>
    </div>
</body>
<script>
    (async function () {
        // ---------------- CONFIG ----------------
        const ROOM_ID = "general";
        const ROOM_NAME = "General";
        const CACHE_LIMIT = 5000;
        const PAGE_SIZE = 40;
        const DEBOUNCE_MS = 400;
        const STICKERS = ["pollo.png", "sticker1.png", "sticker2.webp", "sticker3.webp", "sticker4.webp", "sticker5.webp", "sticker6.webp", "sticker7.webp", "sticker9.webp", "hey-floppa.webp", "no-no-cat.webp", "jajaja.webp", "gato.webp", "gatosorprendido.webp", "gatotrite.webp", "gatotritedenuevo.webp", "OK.webp",];

        // DOM
        const loginOverlay = document.getElementById('loginOverlay');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const activeNameEl = document.getElementById('activeName');
        const messagesEl = document.getElementById('messages');
        const composer = document.getElementById('composer');
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const roomListEl = document.getElementById('roomList');
        const btnRecord = document.getElementById('btnRecord');
        const btnSticker = document.getElementById('btnSticker');
        const stickerPanel = document.getElementById('stickerPanel');
        const stickerGrid = document.getElementById('stickerGrid');
        const closeStickers = document.getElementById('closeStickers');
        const btnImage = document.getElementById('btnImage');
        const imageInput = document.getElementById('imageInput');

        // small menu items
        const msgMenuEl = document.getElementById('msgMenu');
        const menuReply = document.getElementById('menuReply');
        const menuReact = document.getElementById('menuReact');

        // STATE
        const accessKeys = { "marzo10": "leidy", "enero10": "daniel" };
        let currentUser = null;
        let newestTimestamp = 0;
        let replyTo = null;
        let sendTimer = null;
        let typingTimer = null;
        const TYPING_TIMEOUT = 1500;

        // FIREBASE HELPERS
        function fire() { return window.__FIRE && window.__FIRE.db ? window.__FIRE : null; }
        async function ensureFireReady() { const start = Date.now(); while (!fire() || !fire().db) { if (Date.now() - start > 3000) break; await new Promise(r => setTimeout(r, 50)); } }

        // CACHE
        function loadCache() { try { const raw = localStorage.getItem('chat_cache'); return raw ? JSON.parse(raw) : { msgs: [], newest: 0 }; } catch (e) { return { msgs: [], newest: 0 }; } }
        function saveCache(cache) { try { if (cache.msgs.length > CACHE_LIMIT) cache.msgs = cache.msgs.slice(-CACHE_LIMIT); localStorage.setItem('chat_cache', JSON.stringify(cache)); } catch (e) { } }

        // LOGIN
        loginBtn.addEventListener('click', tryLogin);
        passwordInput.addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

        function tryLogin() {
            const pass = passwordInput.value.trim();
            const name = accessKeys[pass];
            if (!name) return alert('Contrase√±a incorrecta');
            currentUser = name;
            activeNameEl.textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
            loginOverlay.style.display = 'none';
            composer.style.display = 'flex';
            initRoomList();
            loadStickers();
            initChat();
        }

        // ROOMS (single room)
        async function initRoomList() {
            await ensureFireReady();
            const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
            const { doc, getDoc, setDoc } = fs;
            roomListEl.innerHTML = `<div class="room-item active" id="room-${ROOM_ID}">${ROOM_NAME}</div>`;
            const roomRef = doc(fire().db, 'chat_rooms', ROOM_ID);
            try {
                const snap = await getDoc(roomRef);
                if (!snap.exists()) await setDoc(roomRef, { name: ROOM_NAME, createdAt: Date.now() });
            } catch (e) {
                // ignore read errors (rules) - UI keeps working
                console.warn('initRoomList:', e);
            }
        }

        // STICKERS
        function loadStickers() {
            stickerGrid.innerHTML = '';
            STICKERS.forEach(s => {
                const item = document.createElement('div'); item.className = 'sticker-item';
                const img = document.createElement('img'); img.src = 'stickers/' + s; img.loading = 'lazy';
                item.appendChild(img);
                item.addEventListener('click', async () => { await sendMessage({ sticker: img.src }); hideStickers(); });
                stickerGrid.appendChild(item);
            });
        }
        btnSticker.addEventListener('click', e => { e.preventDefault(); toggleStickers(); });
        closeStickers.addEventListener('click', hideStickers);
        function toggleStickers() { stickerPanel.style.display = (stickerPanel.style.display === 'block') ? 'none' : 'block'; }
        function hideStickers() { stickerPanel.style.display = 'none'; }

        // IMAGE UPLOAD
        btnImage.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onloadend = async () => { await sendMessage({ image: reader.result }); imageInput.value = ''; };
            reader.readAsDataURL(file);
        });

        // ---------- Sanitizer ----------
        function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ----------------- AUDIO (UI + limits) -----------------
        let mediaRecorder = null;
        let mediaStream = null;
        let audioChunks = [];
        let recording = false;
        let recordIntervalId = null;
        const MAX_BYTES = 2.5 * 1024 * 1024;
        const MAX_SECONDS = 60;

        // build record UI once
        const recordUI = document.createElement('div');
        recordUI.id = 'recordUI';
        recordUI.style.cssText = `
        position:fixed; left:50%; transform:translateX(-50%); bottom:84px;
        z-index:99999; display:none; align-items:center; gap:12px;
        background: linear-gradient(90deg,#091014,#0b1216); color:#fff;
        padding:10px 14px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,0.6);
    `;
        recordUI.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:6px;min-width:220px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="color:#ff5b5b;font-weight:700">‚óè Grabando <span id="recDots">.</span></div>
          <div id="recTimer" style="min-width:56px;text-align:right;font-family:monospace">00:00</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:8px;">
            <div id="recSize" style="font-size:13px;opacity:.9">0 KB</div>
            <div id="recWarn" style="color:#ffcccb;font-size:13px;display:none">L√≠mite 2.5 MB</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="recCancel" style="padding:6px 10px;border-radius:8px;border:none;background:#333;color:#fff;cursor:pointer">Cancelar</button>
            <button id="recSend" style="padding:6px 10px;border-radius:8px;border:none;background:#06b6d4;color:#042431;cursor:pointer">Enviar</button>
          </div>
        </div>
      </div>
    `;
        document.body.appendChild(recordUI);

        function prettyBytes(n) {
            if (n < 1024) return n + ' B';
            if (n < 1024 * 1024) return (n / 1024).toFixed(1) + ' KB';
            return (n / (1024 * 1024)).toFixed(2) + ' MB';
        }

        async function startRecording() {
            if (!currentUser) return alert('Entra al chat antes de grabar');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaStream = stream;
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recording = true;
                recordUI.style.display = 'flex';
                document.getElementById('recDots').textContent = '.';
                document.getElementById('recWarn').style.display = 'none';
                document.getElementById('recSize').textContent = '0 KB';
                document.getElementById('recTimer').textContent = '00:00';
                document.getElementById('recSend').disabled = false;

                mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) audioChunks.push(e.data); };
                mediaRecorder.start();

                const startedAt = Date.now();
                recordIntervalId = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startedAt) / 1000);
                    const mm = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const ss = String(elapsed % 60).padStart(2, '0');
                    document.getElementById('recTimer').textContent = `${mm}:${ss}`;

                    const size = audioChunks.reduce((s, b) => s + (b.size || 0), 0);
                    document.getElementById('recSize').textContent = prettyBytes(size);

                    if (size > MAX_BYTES) {
                        document.getElementById('recWarn').style.display = 'block';
                        document.getElementById('recSend').disabled = true;
                    } else {
                        document.getElementById('recWarn').style.display = 'none';
                        document.getElementById('recSend').disabled = false;
                    }

                    // auto-stop at limit
                    if (elapsed >= MAX_SECONDS) {
                        stopRecording(true);
                    }
                }, 250);

                // buttons handlers
                document.getElementById('recCancel').onclick = () => {
                    // stop recording and discard
                    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                    cleanupRecordingUI();
                };
                document.getElementById('recSend').onclick = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording(true);
                };

                // animate dots
                let dotsInterval = setInterval(() => {
                    if (!recording) { clearInterval(dotsInterval); return; }
                    const el = document.getElementById('recDots');
                    if (el) el.textContent = el.textContent.length < 3 ? el.textContent + '.' : '.';
                }, 350);

            } catch (e) {
                console.error('startRecording', e);
                alert('No se pudo acceder al micr√≥fono');
            }
        }

        function cleanupRecordingUI() {
            recording = false;
            if (recordIntervalId) { clearInterval(recordIntervalId); recordIntervalId = null; }
            recordUI.style.display = 'none';
            try {
                if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            } catch (e) { }
            mediaStream = null;
            mediaRecorder = null;
            audioChunks = [];
        }

        function stopRecording(autoSend) {
            if (!mediaRecorder) { cleanupRecordingUI(); return; }
            if (mediaRecorder.state === 'inactive') { cleanupRecordingUI(); return; }

            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
                const size = blob.size;
                if (size > MAX_BYTES) {
                    alert('El audio supera 2.5 MB. Cancela o graba m√°s corto.');
                    cleanupRecordingUI();
                    return;
                }
                if (autoSend) {
                    await sendAudioBlob(blob);
                    cleanupRecordingUI();
                } else {
                    // fallback: send
                    await sendAudioBlob(blob);
                    cleanupRecordingUI();
                }
            };
            mediaRecorder.stop();
        }

        async function sendAudioBlob(blob) {
            const reader = new FileReader();
            reader.onloadend = async () => { await sendMessage({ audio: reader.result, mime: blob.type }); };
            reader.readAsDataURL(blob);
        }

        btnRecord.addEventListener('click', (e) => { e.preventDefault(); if (!recording) startRecording(); else stopRecording(true); });

        // ---------------- CHAT INIT / LOAD ----------------
        async function initChat() { await ensureFireReady(); await loadLatestMessages(); listenNewMessages(); listenTypingStatus(); }

        async function loadLatestMessages() {
            try {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, query, orderBy, limit, getDocs } = fs;
                const msgsRef = collection(fire().db, `chat_rooms/${ROOM_ID}/messages`);
                const q = query(msgsRef, orderBy('time', 'desc'), limit(PAGE_SIZE));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const docs = snap.docs.reverse();
                    const msgs = docs.map(d => ({ id: d.id, ...d.data() }));
                    newestTimestamp = msgs[msgs.length - 1].time || Date.now();
                    saveCache({ msgs, newest: newestTimestamp });
                    renderMessages(msgs);
                }
            } catch (e) { console.error('loadLatestMessages', e); }
        }

        async function listenNewMessages() {
            try {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, query, where, orderBy, onSnapshot } = fs;
                const msgsRef = collection(fire().db, `chat_rooms/${ROOM_ID}/messages`);
                const qNew = query(msgsRef, where('time', '>', newestTimestamp), orderBy('time'));
                onSnapshot(qNew, snap => {
                    if (!snap.empty) appendNewMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
            } catch (e) { console.warn('listenNewMessages', e); }
        }

        function appendNewMessages(newMsgs) {
            if (!newMsgs || !newMsgs.length) return;
            const cache = loadCache();
            const existingIds = new Set(cache.msgs.map(m => m.id));
            const filtered = newMsgs.filter(m => !existingIds.has(m.id));
            if (!filtered.length) return;
            cache.msgs = cache.msgs.concat(filtered);
            cache.newest = Math.max(cache.newest || 0, ...filtered.map(m => m.time || 0));
            saveCache(cache);
            filtered.forEach(m => appendMessageToDOM(m));
            newestTimestamp = cache.newest;
        }

        // ---------------- SEND MESSAGE ----------------
        async function sendMessage(extra = {}) {
            if (!currentUser) return;
            const text = msgInput?.value?.trim() || '';
            if (!text && !extra.audio && !extra.sticker && !extra.image) return;
            if (sendTimer) clearTimeout(sendTimer);
            sendTimer = setTimeout(async () => {
                try {
                    const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                    const { collection, addDoc } = fs;
                    const data = { from: currentUser, time: Date.now(), text: text || '', ...extra };
                    if (replyTo) { data.replyTo = { id: replyTo.id, from: replyTo.from, text: replyTo.text || null }; replyTo = null; msgInput.placeholder = 'Escribe un mensaje...'; }
                    await addDoc(collection(fire().db, `chat_rooms/${ROOM_ID}/messages`), data);
                    if (msgInput) msgInput.value = '';
                } catch (e) { console.error('sendMessage', e); alert('No se pudo enviar'); }
            }, DEBOUNCE_MS);
        }
        sendBtn.addEventListener('click', e => { e.preventDefault(); sendMessage(); });
        msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

        // ---------------- TYPING ----------------
        msgInput.addEventListener('input', () => {
            setTypingStatus(true);
            if (typingTimer) clearTimeout(typingTimer);
            typingTimer = setTimeout(() => setTypingStatus(false), TYPING_TIMEOUT);
        });

        async function setTypingStatus(isTyping) {
            try {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { doc, setDoc } = fs;
                await setDoc(doc(fire().db, `chat_rooms/${ROOM_ID}/typing_status`, currentUser), { typing: isTyping, time: Date.now() }, { merge: true });
            } catch (e) { console.error('setTypingStatus', e); }
        }

        async function listenTypingStatus() {
            try {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { collection, onSnapshot } = fs;
                onSnapshot(collection(fire().db, `chat_rooms/${ROOM_ID}/typing_status`), snap => {
                    const typingUsers = [];
                    snap.docs.forEach(d => { const data = d.data(); if (data.typing && d.id !== currentUser) typingUsers.push(d.id); });
                    document.getElementById('typingIndicator').textContent = typingUsers.length ? `${typingUsers.join(', ')} escribiendo...` : '';
                });
            } catch (e) { console.warn('listenTypingStatus', e); }
        }

        // ---------------- RENDER & MENU ----------------
        function renderMessages(list) { messagesEl.innerHTML = ''; list.forEach(m => appendMessageToDOM(m)); }

        let selectedMsg = null;

        function appendMessageToDOM(m) {
            const cache = loadCache();
            cache.msgs.push(m);
            if (cache.msgs.length > CACHE_LIMIT) cache.msgs = cache.msgs.slice(-CACHE_LIMIT);
            cache.newest = Math.max(cache.newest || 0, m.time || 0);
            saveCache(cache);

            const div = document.createElement('div');
            div.className = 'msg ' + ((m.from === currentUser) ? 'daniel' : 'leidy');

            const avatarUrl = (m.from === 'daniel') ? 'daniel.jpg' : 'leidy.jpg';

            let inner = `
            <div class="bubble-avatar"><img src="${avatarUrl}" loading="lazy" decoding="async" onerror="this.style.display='none'"></div>
            <div class="bubble-content">
                <div class="bubble-name">${esc(m.from || '')}</div>
        `;
            if (m.replyTo) inner += `<div class="reply-box">${esc(m.replyTo.from)}: ${esc(m.replyTo.text || 'Imagen')}</div>`;
            if (m.text) inner += `<div class="bubble-text">${esc(m.text)}</div>`;
            if (m.image) inner += `<img src="${m.image}" class="bubble-image" loading="lazy" decoding="async">`;
            if (m.sticker) inner += `<img src="${m.sticker}" class="bubble-image" style="width:140px;border-radius:12px">`;
            if (m.audio) inner += `<audio controls preload="none" src="${m.audio}"></audio>`;
            if (m.reaction) inner += `<div class="reaction">${m.reaction}</div>`;
            inner += `<div class="bubble-meta">${new Date(m.time || Date.now()).toLocaleTimeString()}</div></div>`;

            div.innerHTML = inner;

            // short tap/click: quick reply (mobile-friendly)
            div.addEventListener('click', (ev) => {
                ev.stopPropagation();
                replyTo = m;
                msgInput.placeholder = `Respondiendo a ${m.from}...`;
                div.style.transform = 'scale(0.998)';
                setTimeout(() => div.style.transform = '', 110);
            });

            // right-click opens menu on desktop
            div.addEventListener('contextmenu', (ev) => {
                ev.preventDefault(); ev.stopPropagation();
                openMsgMenuAt(ev.clientX, ev.clientY, m);
            });

            // long-press on touch devices
            let touchTimer = null;
            div.addEventListener('touchstart', (ev) => {
                touchTimer = setTimeout(() => {
                    const t = ev.touches[0];
                    openMsgMenuAt(t.clientX, t.clientY, m);
                }, 520);
            });
            div.addEventListener('touchend', () => { if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; } });

            messagesEl.appendChild(div);
            messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
        }

        function openMsgMenuAt(x, y, msgData) {
            selectedMsg = msgData;
            if (!msgMenuEl) return;
            msgMenuEl.style.display = 'flex';
            msgMenuEl.style.animation = 'menuPop .12s ease both';
            const vw = window.innerWidth, vh = window.innerHeight;
            const mw = Math.min(220, vw - 24);
            let left = x, top = y;
            if (left + mw > vw) left = vw - mw - 8;
            if (top + 120 > vh) top = Math.max(8, vh - 140);
            msgMenuEl.style.left = left + 'px';
            msgMenuEl.style.top = top + 'px';
        }

        // close menu when clicking outside (already handled by global listener earlier)
        document.addEventListener('click', (ev) => {
            if (!msgMenuEl) return;
            if (!msgMenuEl.contains(ev.target)) msgMenuEl.style.display = 'none';
        });

        // menu actions
        if (menuReply) menuReply.addEventListener('click', () => {
            if (!selectedMsg) return;
            replyTo = selectedMsg;
            msgInput.placeholder = `Respondiendo a ${selectedMsg.from}...`;
            msgMenuEl.style.display = 'none';
        });
        if (menuReact) menuReact.addEventListener('click', async () => {
            if (!selectedMsg) return;
            try {
                const fs = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const { doc, updateDoc } = fs;
                await updateDoc(doc(fire().db, `chat_rooms/${ROOM_ID}/messages`, selectedMsg.id), { reaction: "‚ù§Ô∏è" });
            } catch (e) { console.error('menuReact', e); }
            msgMenuEl.style.display = 'none';
        });

        // click outside stickers hides them
        document.addEventListener('click', e => {
            if (stickerPanel && stickerPanel.style.display === 'block' && !stickerPanel.contains(e.target) && !btnSticker.contains(e.target)) hideStickers();
        });

        // start (focus)
        passwordInput.focus();

    })();
</script>



</html>